# auth-backend-layers: auth context の infrastructure〜presentation 全層を実装

## タスク ID
auth-backend-layers

## 作成・変更したファイル
- `src/backend/contexts/auth/domain/gateways/auth.gateway.ts` — signInWithGoogle の戻り値を `{ url: string }` に変更、onAuthStateChange 削除（サーバーサイド不要）
- `src/backend/contexts/auth/infrastructure/supabase-auth.gateway.ts` — AuthGateway の Supabase 実装（getCurrentUser, signInWithGoogle, signOut）
- `src/backend/contexts/auth/infrastructure/repositories/prisma-user.repository.ts` — UserRepository の Prisma 実装（findById, findByEmail, upsert）
- `src/backend/contexts/auth/application/usecases/get-current-user.usecase.ts` — 現在ユーザー取得
- `src/backend/contexts/auth/application/usecases/sign-in.usecase.ts` — Google OAuth URL 生成
- `src/backend/contexts/auth/application/usecases/sign-out.usecase.ts` — サインアウト
- `src/backend/contexts/auth/application/usecases/sync-user.usecase.ts` — Supabase auth.users → アプリ users テーブル同期
- `src/backend/contexts/auth/presentation/composition/auth.composition.ts` — Composition Root
- `src/backend/contexts/auth/presentation/actions/sign-in.action.ts` — Server Action（OAuth redirect）
- `src/backend/contexts/auth/presentation/actions/sign-out.action.ts` — Server Action（signout + redirect /login）
- `src/backend/contexts/auth/presentation/loaders/current-user.loader.ts` — Server Component 用 loader
- `src/backend/contexts/shared/infrastructure/db/prisma-client.ts` — PrismaClient シングルトン
- `src/backend/contexts/auth/application/usecases/__tests__/` — 4 UseCase のユニットテスト

## 設計判断
- AuthGateway.signInWithGoogle を `Promise<{ url: string }>` に変更。サーバーサイドでは redirect URL を生成し、action 層で `redirect()` する設計
- onAuthStateChange はブラウザ専用のため interface から削除（サーバーサイド認証の scope では不要）
- PrismaClient シングルトン（globalThis パターン）を shared/infrastructure/db に配置

## 次のタスクへの申し送り
- auth/callback ルート（Supabase OAuth コールバック処理 + SyncUserUseCase 呼び出し）は未実装
- middleware.ts での認証チェック・リダイレクトは未実装
- NEXT_PUBLIC_SITE_URL 環境変数が sign-in.action.ts で必要（未設定時は localhost:3000 fallback）
