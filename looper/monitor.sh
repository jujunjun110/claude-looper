#!/bin/bash
# looper/monitor.sh — Builder セッションのリアルタイム監視
#
# 使い方:
#   watch -n3 bash looper/monitor.sh          # 3秒ごとに自動更新
#   bash looper/monitor.sh                    # 1回だけ表示
#   bash looper/monitor.sh 30                 # 直近30分のログのみ（デフォルト10分）

LOG_DIR="${RALPH_LOG_DIR:-/tmp/ralph-logs}"
MINUTES="${1:-10}"

echo "=== Ralph Monitor (直近 ${MINUTES} 分) ==="
echo ""

found=false
for logfile in $(find "$LOG_DIR" -name '*.log' -mmin "-$MINUTES" | sort); do
	[ -f "$logfile" ] || continue
	found=true
	name=$(basename "$logfile" .log)
	size=$(wc -c < "$logfile" | tr -d ' ')
	updated=$(stat -f '%Sm' -t '%H:%M:%S' "$logfile" 2>/dev/null || stat -c '%y' "$logfile" 2>/dev/null | cut -d. -f1)

	# 最後の assistant イベントからアクティビティを抽出
	last_activity=$(tail -30 "$logfile" | jq -r '
		select(.type == "assistant") |
		.message.content[]? |
		if .type == "tool_use" then
			"[" + .name + "] " + (
				.input |
				if .file_path then (.file_path | split("/") | last)
				elif .command then (.command | split("\n") | first | .[0:50])
				elif .pattern then .pattern
				elif .content then "writing..."
				elif .todos then "updating..."
				else ""
				end
			)
		elif .type == "text" then
			(.text | split("\n") | first | .[0:70])
		else empty
		end
	' 2>/dev/null | tail -1)

	[ -z "$last_activity" ] && last_activity="(stream-json 以前のログ)"

	printf "  %-40s %s  %4dKB  %s\n" "$name" "$updated" "$((size / 1024))" "$last_activity"
done

if ! $found; then
	echo "  (アクティブなログなし)"
fi
